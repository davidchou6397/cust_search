<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½æ½›åœ¨å®¢ç¾¤æœå°‹ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .init-section {
            background: #f8f9fa;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .search-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .search-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 24px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .tab-btn:hover {
            border-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-box input, .search-box select {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .search-box input:focus, .search-box select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .filter-section {
            margin-top: 20px;
        }
        
        .filter-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .tag {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #ddd;
            background: white;
        }
        
        .tag.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .tag:hover {
            border-color: #667eea;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .results-header h2 {
            color: #333;
        }
        
        .stats {
            color: #666;
            font-size: 14px;
        }
        
        .customer-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .customer-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: #667eea;
        }
        
        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .customer-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .customer-type {
            color: #666;
            font-size: 14px;
        }
        
        .customer-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .customer-tag {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .tag-high { background: #d4edda; color: #155724; }
        .tag-medium { background: #fff3cd; color: #856404; }
        .tag-low { background: #f8d7da; color: #721c24; }
        .tag-new { background: #d1ecf1; color: #0c5460; }
        .tag-growth { background: #cce5ff; color: #004085; }
        
        .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 14px;
        }
        
        .info-icon {
            color: #667eea;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            max-width: 500px;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px auto;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .industry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .industry-card {
            padding: 20px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .industry-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .industry-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .range-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .stats-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            text-align: center;
        }
        
        .stats-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stats-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .search-box {
                flex-direction: column;
            }
            
            .search-box input, .search-box select {
                width: 100%;
            }
            
            .customer-header {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ å…¨æ–¹ä½æ½›åœ¨å®¢ç¾¤æœå°‹ç³»çµ±</h1>
            <p>æ™ºèƒ½ç”¢æ¥­åˆ†æ Â· ç²¾æº–å®¢æˆ¶å®šä½ Â· å¸‚å ´æƒ…å ±è¿½è¹¤</p>
        </div>
        
        <div class="main-content">
            <!-- åˆå§‹åŒ–å€ -->
            <div class="init-section" id="initSection">
                <div style="font-size: 64px; margin-bottom: 20px;">ğŸš€</div>
                <h2 style="margin-bottom: 15px;">ç³»çµ±åˆå§‹åŒ–</h2>
                <p style="color: #666; margin-bottom: 30px;">
                    ç³»çµ±å°‡è‡ªå‹•è¼‰å…¥ä»¥ä¸‹è³‡æ–™ï¼š<br>
                    âœ“ å…¨å°å…¬å¸ç™»è¨˜åŸºæœ¬è³‡æ–™<br>
                    âœ“ ç‡Ÿæ¥­é …ç›®ä»£ç¢¼å°ç…§è¡¨<br>
                    âœ“ ç”¢æ¥­åˆ†é¡æ¨™æº–<br>
                    <br>
                    é¦–æ¬¡è¼‰å…¥ç´„éœ€ 3-5 åˆ†é˜ï¼Œè«‹è€å¿ƒç­‰å€™
                </p>
                <button class="btn btn-primary" onclick="initializeSystem()" style="font-size: 18px; padding: 20px 40px;">
                    ğŸš€ é–‹å§‹åˆå§‹åŒ–ç³»çµ±
                </button>
                <div id="loadingProgress" style="margin-top: 30px;"></div>
            </div>
            
            <!-- æœå°‹å€ -->
            <div class="search-section" id="searchSection" style="display: none;">
                <h3 style="margin-bottom: 15px; color: #333;">ğŸ” å¤šç¶­åº¦æœå°‹</h3>
                
                <!-- æœå°‹åˆ†é  -->
                <div class="search-tabs">
                    <button class="tab-btn active" onclick="switchTab('keyword')">ğŸ” é—œéµå­—æœå°‹</button>
                    <button class="tab-btn" onclick="switchTab('industry')">ğŸ¢ ç”¢æ¥­åˆ†é¡</button>
                    <button class="tab-btn" onclick="switchTab('capital')">ğŸ’° è³‡æœ¬é¡ç¯©é¸</button>
                    <button class="tab-btn" onclick="switchTab('new')">ğŸ†• æ–°è¨­ç«‹å…¬å¸</button>
                    <button class="tab-btn" onclick="switchTab('advanced')">âš™ï¸ é€²éšæœå°‹</button>
                </div>
                
                <!-- é—œéµå­—æœå°‹ -->
                <div id="tab-keyword" class="tab-content active">
                    <div class="search-box">
                        <input type="text" id="keywordInput" placeholder="è¼¸å…¥å…¬å¸åç¨±æˆ–é—œéµå­—...ï¼ˆä¾‹å¦‚ï¼šåŒ…è£ã€å°åˆ·ã€ç§‘æŠ€ï¼‰">
                        <button class="btn btn-primary" onclick="searchByKeyword()">æœå°‹</button>
                    </div>
                    <div style="padding: 10px; background: #e7f3ff; border-radius: 8px; font-size: 14px;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>æ”¯æ´å…¬å¸åç¨±æ¨¡ç³Šæœå°‹ï¼Œå¯æœå°‹ç”¢æ¥­é—œéµå­—ã€ç”¢å“åç¨±ç­‰
                    </div>
                </div>
                
                <!-- ç”¢æ¥­åˆ†é¡æœå°‹ -->
                <div id="tab-industry" class="tab-content">
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; color: #333;">é¸æ“‡ç”¢æ¥­å¤§é¡ï¼š</label>
                        <select id="industrySelect" class="search-box" style="margin-top: 10px; width: 100%;" onchange="loadIndustrySubcategories()">
                            <option value="">-- è«‹é¸æ“‡ç”¢æ¥­å¤§é¡ --</option>
                        </select>
                    </div>
                    <div id="industrySubGrid" class="industry-grid" style="display: none;">
                        <!-- å‹•æ…‹è¼‰å…¥ç”¢æ¥­å°é¡ -->
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="searchByIndustry()">æœå°‹é¸å®šç”¢æ¥­</button>
                    </div>
                </div>
                
                <!-- è³‡æœ¬é¡ç¯©é¸ -->
                <div id="tab-capital" class="tab-content">
                    <div class="search-box">
                        <div class="range-input" style="flex: 1;">
                            <label>æœ€ä½è³‡æœ¬é¡ï¼š</label>
                            <input type="number" id="minCapital" placeholder="ä¾‹å¦‚ï¼š1000000" style="flex: 1;">
                        </div>
                        <div class="range-input" style="flex: 1;">
                            <label>æœ€é«˜è³‡æœ¬é¡ï¼š</label>
                            <input type="number" id="maxCapital" placeholder="ä¾‹å¦‚ï¼š100000000" style="flex: 1;">
                        </div>
                        <button class="btn btn-primary" onclick="searchByCapital()">æœå°‹</button>
                    </div>
                    <div class="industry-grid" style="margin-top: 20px;">
                        <div class="industry-card" onclick="setCapitalRange(0, 1000000)">
                            <div style="font-size: 32px;">ğŸª</div>
                            <div style="font-weight: bold; margin: 10px 0;">å°å‹ä¼æ¥­</div>
                            <div style="color: #666; font-size: 14px;">100è¬ä»¥ä¸‹</div>
                        </div>
                        <div class="industry-card" onclick="setCapitalRange(1000000, 10000000)">
                            <div style="font-size: 32px;">ğŸ¢</div>
                            <div style="font-weight: bold; margin: 10px 0;">ä¸­å‹ä¼æ¥­</div>
                            <div style="color: #666; font-size: 14px;">100è¬ - 1åƒè¬</div>
                        </div>
                        <div class="industry-card" onclick="setCapitalRange(10000000, 100000000)">
                            <div style="font-size: 32px;">ğŸ­</div>
                            <div style="font-weight: bold; margin: 10px 0;">å¤§å‹ä¼æ¥­</div>
                            <div style="color: #666; font-size: 14px;">1åƒè¬ - 1å„„</div>
                        </div>
                        <div class="industry-card" onclick="setCapitalRange(100000000, 999999999999)">
                            <div style="font-size: 32px;">ğŸ›ï¸</div>
                            <div style="font-weight: bold; margin: 10px 0;">è¶…å¤§å‹ä¼æ¥­</div>
                            <div style="color: #666; font-size: 14px;">1å„„ä»¥ä¸Š</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ–°è¨­ç«‹å…¬å¸ -->
                <div id="tab-new" class="tab-content">
                    <div class="search-box">
                        <select id="newCompanyMonth" style="flex: 1;">
                            <option value="1">æœ€è¿‘ 1 å€‹æœˆ</option>
                            <option value="3">æœ€è¿‘ 3 å€‹æœˆ</option>
                            <option value="6">æœ€è¿‘ 6 å€‹æœˆ</option>
                            <option value="12">æœ€è¿‘ 1 å¹´</option>
                        </select>
                        <button class="btn btn-success" onclick="searchNewCompanies()">ğŸ†• æœå°‹æ–°è¨­ç«‹å…¬å¸</button>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #d1ecf1; border-radius: 8px; font-size: 14px;">
                        <strong>ğŸ’¡ å•†æ©Ÿæç¤ºï¼š</strong>æ–°è¨­ç«‹å…¬å¸é€šå¸¸æœ‰å¤§é‡æ¡è³¼éœ€æ±‚ï¼Œæ˜¯é–‹ç™¼æ–°å®¢æˆ¶çš„çµ•ä½³æ™‚æ©Ÿï¼
                    </div>
                </div>
                
                <!-- é€²éšæœå°‹ -->
                <div id="tab-advanced" class="tab-content">
                    <div class="search-box" style="flex-direction: column; gap: 15px;">
                        <div style="display: flex; gap: 10px; width: 100%;">
                            <input type="text" id="advKeyword" placeholder="å…¬å¸åç¨±é—œéµå­—" style="flex: 1;">
                            <select id="advStatus" style="flex: 1;">
                                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                                <option value="æ ¸å‡†è¨­ç«‹">æ ¸å‡†è¨­ç«‹</option>
                                <option value="æ ¸å‡†è¨­ç«‹ï¼Œåœ¨æ¸…ç®—ç¨‹åºä¸­">æ¸…ç®—ä¸­</option>
                                <option value="æ ¸å‡†è¨­ç«‹ï¼Œå·²å ±å‚™è§£æ•£">å·²å ±å‚™è§£æ•£</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; width: 100%;">
                            <input type="text" id="advAddress" placeholder="åœ°å€é—œéµå­—ï¼ˆä¾‹å¦‚ï¼šå°åŒ—å¸‚ã€æ–°ç«¹ï¼‰" style="flex: 1;">
                            <select id="advIndustry" style="flex: 1;">
                                <option value="">æ‰€æœ‰ç”¢æ¥­</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; width: 100%;">
                            <input type="number" id="advMinCapital" placeholder="æœ€ä½è³‡æœ¬é¡" style="flex: 1;">
                            <input type="number" id="advMaxCapital" placeholder="æœ€é«˜è³‡æœ¬é¡" style="flex: 1;">
                        </div>
                        <button class="btn btn-primary" onclick="advancedSearch()" style="width: 100%;">ğŸ” é€²éšæœå°‹</button>
                    </div>
                </div>
                
                <!-- è³‡æ–™çµ±è¨ˆ -->
                <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 10px; border: 2px solid #e9ecef;">
                    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px;">
                        <div class="stats-box" style="flex: 1; min-width: 150px;">
                            <div class="stats-number" id="totalCompaniesCount">0</div>
                            <div class="stats-label">ç¸½å…¬å¸æ•¸</div>
                        </div>
                        <div class="stats-box" style="flex: 1; min-width: 150px;">
                            <div class="stats-number" id="totalIndustriesCount">0</div>
                            <div class="stats-label">ç”¢æ¥­åˆ†é¡</div>
                        </div>
                        <div class="stats-box" style="flex: 1; min-width: 150px;">
                            <div class="stats-number" id="searchResultsCount">0</div>
                            <div class="stats-label">æœå°‹çµæœ</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- çµæœå€ -->
            <div class="results-section" id="resultsSection" style="display: none;">
                <div class="results-header">
                    <h2>ğŸ¯ æœå°‹çµæœ</h2>
                    <div class="stats" id="statsDisplay">è«‹ä½¿ç”¨ä¸Šæ–¹æœå°‹åŠŸèƒ½</div>
                </div>
                
                <div id="resultsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <h3>è«‹ä½¿ç”¨ä¸Šæ–¹æœå°‹åŠŸèƒ½é–‹å§‹æŸ¥è©¢</h3>
                    </div>
                </div>
            </div>
            
            <div class="export-section" id="exportSection" style="display: none;">
                <div>
                    <strong>ğŸ’¾ åŒ¯å‡ºåŠŸèƒ½</strong>
                    <p style="color: #666; font-size: 14px; margin-top: 5px;">å°‡æœå°‹çµæœåŒ¯å‡ºç‚º CSV æª”æ¡ˆ</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="exportToCSV()">ğŸ“¥ åŒ¯å‡º CSV</button>
                    <button class="btn btn-secondary" onclick="exportToExcel()">ğŸ“Š åŒ¯å‡º Excel æ ¼å¼</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        let allCompanies = [];
        let businessCodes = [];
        let industryCategories = {};
        let searchResults = [];
        let selectedIndustries = [];
        
        // ç³»çµ±åˆå§‹åŒ–
        async function initializeSystem() {
            const progressDiv = document.getElementById('loadingProgress');
            progressDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill">0%</div>
                    </div>
                    <p style="color: #666; font-size: 14px; margin-top: 10px;" id="progressText">æº–å‚™è¼‰å…¥è³‡æ–™...</p>
                </div>
            `;
            
            try {
                // æ­¥é©Ÿ 1: è¼‰å…¥ç‡Ÿæ¥­é …ç›®ä»£ç¢¼è¡¨
                updateProgress(10, 'æ­£åœ¨è¼‰å…¥ç‡Ÿæ¥­é …ç›®ä»£ç¢¼è¡¨...');
                await loadBusinessCodes();
                
                // æ­¥é©Ÿ 2: è¼‰å…¥å…¬å¸åŸºæœ¬è³‡æ–™
                updateProgress(40, 'æ­£åœ¨è¼‰å…¥å…¨å°å…¬å¸è³‡æ–™...');
                await loadCompanyData();
                
                // æ­¥é©Ÿ 3: å»ºç«‹ç”¢æ¥­åˆ†é¡ç´¢å¼•
                updateProgress(80, 'æ­£åœ¨å»ºç«‹ç”¢æ¥­åˆ†é¡ç´¢å¼•...');
                buildIndustryIndex();
                
                // æ­¥é©Ÿ 4: å®Œæˆåˆå§‹åŒ–
                updateProgress(100, 'ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼');
                
                setTimeout(() => {
                    showSystemReady();
                }, 500);
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—ï¼š', error);
                showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // è¼‰å…¥ç‡Ÿæ¥­é …ç›®ä»£ç¢¼è¡¨
        async function loadBusinessCodes() {
            try {
                const response = await fetch('https://data.gcis.nat.gov.tw/od/data/api/FCB90AB1-E382-45CE-8D4F-394861851E28?$format=json&$top=10000');
                
                if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥ç‡Ÿæ¥­é …ç›®ä»£ç¢¼è¡¨');
                
                businessCodes = await response.json();
                console.log('ç‡Ÿæ¥­é …ç›®ä»£ç¢¼è¼‰å…¥å®Œæˆï¼š', businessCodes.length, 'ç­†');
                
                // å»ºç«‹ç”¢æ¥­åˆ†é¡
                businessCodes.forEach(code => {
                    const category = code.Category || code.é¡åˆ¥;
                    const categoryName = code.Category_Name || code.é¡åˆ¥åç¨±;
                    
                    if (category && !industryCategories[category]) {
                        industryCategories[category] = {
                            name: categoryName,
                            codes: []
                        };
                    }
                    
                    if (category) {
                        industryCategories[category].codes.push(code);
                    }
                });
                
            } catch (error) {
                console.error('è¼‰å…¥ç‡Ÿæ¥­é …ç›®ä»£ç¢¼è¡¨å¤±æ•—ï¼š', error);
                throw error;
            }
        }
        
        // è¼‰å…¥å…¬å¸è³‡æ–™
        async function loadCompanyData() {
            try {
                const csvUrl = 'https://data.gcis.nat.gov.tw/od/file?oid=5F64D864-61CB-4D0D-8AD9-492047CC1EA6';
                const response = await fetch(csvUrl);
                
                if (!response.ok) throw new Error('ç„¡æ³•ä¸‹è¼‰å…¬å¸è³‡æ–™');
                
                const csvText = await response.text();
                
                return new Promise((resolve, reject) => {
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        encoding: 'UTF-8',
                        complete: function(results) {
                            allCompanies = results.data.map(row => ({
                                name: row['Company_Name'] || row['å…¬å¸åç¨±'] || '',
                                taxId: row['Business_Accounting_NO'] || row['çµ±ä¸€ç·¨è™Ÿ'] || '',
                                status: row['Company_Status_Desc'] || row['å…¬å¸ç‹€æ…‹'] || '',
                                capital: parseInt(row['Capital_Stock_Amount'] || row['è³‡æœ¬ç¸½é¡(å…ƒ)'] || '0'),
                                address: row['Company_Location'] || row['å…¬å¸æ‰€åœ¨åœ°'] || '',
                                date: row['Approve_Date'] || row['æ ¸å‡†è¨­ç«‹æ—¥æœŸ'] || '',
                                business: row['Cmp_Business'] || row['æ‰€ç‡Ÿäº‹æ¥­'] || '',
                                chairman: row['Responsible_Name'] || row['è² è²¬äºº'] || ''
                            })).filter(company => company.name && company.name.trim());
                            
                            // å»é‡
                            const uniqueCompanies = [];
                            const seen = new Set();
                            
                            allCompanies.forEach(company => {
                                const key = company.taxId || company.name;
                                if (!seen.has(key)) {
                                    seen.add(key);
                                    uniqueCompanies.push(company);
                                }
                            });
                            
                            allCompanies = uniqueCompanies;
                            console.log('å…¬å¸è³‡æ–™è¼‰å…¥å®Œæˆï¼š', allCompanies.length, 'ç­†');
                            resolve();
                        },
                        error: function(error) {
                            reject(error);
                        }
                    });
                });
                
            } catch (error) {
                console.error('è¼‰å…¥å…¬å¸è³‡æ–™å¤±æ•—ï¼š', error);
                throw error;
            }
        }
        
        // å»ºç«‹ç”¢æ¥­åˆ†é¡ç´¢å¼•
        function buildIndustryIndex() {
            // å¡«å……ç”¢æ¥­é¸æ“‡å™¨
            const industrySelect = document.getElementById('industrySelect');
            const advIndustry = document.getElementById('advIndustry');
            
            Object.keys(industryCategories).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = `${category} - ${industryCategories[category].name}`;
                industrySelect.appendChild(option);
                
                const option2 = option.cloneNode(true);
                advIndustry.appendChild(option2);
            });
        }
        
        // æ›´æ–°é€²åº¦
        function updateProgress(percent, text) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            if (progressFill) {
                progressFill.style.width = percent + '%';
                progressFill.textContent = percent + '%';
            }
            if (progressText) {
                progressText.textContent = text;
            }
        }
        
        // é¡¯ç¤ºç³»çµ±å°±ç·’
        function showSystemReady() {
            document.getElementById('initSection').style.display = 'none';
            document.getElementById('searchSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'block';
            
            // æ›´æ–°çµ±è¨ˆæ•¸å­—
            document.getElementById('totalCompaniesCount').textContent = allCompanies.length.toLocaleString();
            document.getElementById('totalIndustriesCount').textContent = Object.keys(industryCategories).length;
            
            document.getElementById('resultsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âœ…</div>
                    <h3>ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼</h3>
                    <p style="margin: 15px 0;">
                        å·²è¼‰å…¥ <strong style="color: #667eea; font-size: 24px;">${allCompanies.length.toLocaleString()}</strong> å®¶å…¬å¸è³‡æ–™<br>
                        æ¶µè“‹ <strong style="color: #667eea; font-size: 24px;">${Object.keys(industryCategories).length}</strong> å€‹ç”¢æ¥­åˆ†é¡
                    </p>
                    <p style="color: #666;">è«‹ä½¿ç”¨ä¸Šæ–¹æœå°‹åŠŸèƒ½é–‹å§‹æŸ¥è©¢æ½›åœ¨å®¢æˆ¶</p>
                </div>
            `;
        }
        
        // é¡¯ç¤ºéŒ¯èª¤
        function showError(message) {
            document.getElementById('loadingProgress').innerHTML = `
                <div style="padding: 30px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                    <h3 style="color: #d32f2f;">åˆå§‹åŒ–å¤±æ•—</h3>
                    <p style="color: #666; margin: 15px 0;">${message}</p>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="initializeSystem()">é‡æ–°åˆå§‹åŒ–</button>
                    </div>
                </div>
            `;
        }
        
        // åˆ‡æ›æœå°‹åˆ†é 
        function switchTab(tabName) {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ›´æ–°å…§å®¹é¡¯ç¤º
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
        }
        
        // é—œéµå­—æœå°‹
        function searchByKeyword() {
            const keyword = document.getElementById('keywordInput').value.trim().toLowerCase();
            
            if (!keyword) {
                alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
                return;
            }
            
            showLoading();
            
            setTimeout(() => {
                searchResults = allCompanies.filter(company => 
                    company.name.toLowerCase().includes(keyword) ||
                    company.business.toLowerCase().includes(keyword) ||
                    company.address.toLowerCase().includes(keyword)
                );
                
                displayResults(searchResults, `é—œéµå­—ã€Œ${keyword}ã€`);
            }, 300);
        }
        
        // è¼‰å…¥ç”¢æ¥­å°é¡
        function loadIndustrySubcategories() {
            const category = document.getElementById('industrySelect').value;
            const subGrid = document.getElementById('industrySubGrid');
            
            if (!category) {
                subGrid.style.display = 'none';
                return;
            }
            
            const codes = industryCategories[category].codes;
            
            // æŒ‰å°é¡åˆ†çµ„
            const subcategories = {};
            codes.forEach(code => {
                const subcat = code.Subcategories_Name || code.è¡Œæ¥­å°é¡åç¨± || 'å…¶ä»–';
                if (!subcategories[subcat]) {
                    subcategories[subcat] = [];
                }
                subcategories[subcat].push(code);
            });
            
            // é¡¯ç¤ºå°é¡
            subGrid.innerHTML = '';
            Object.keys(subcategories).forEach(subcat => {
                const card = document.createElement('div');
                card.className = 'industry-card';
                card.onclick = () => toggleIndustrySelection(card, subcategories[subcat]);
                card.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${subcat}</div>
                    <div style="color: #666; font-size: 14px;">${subcategories[subcat].length} å€‹é …ç›®</div>
                `;
                subGrid.appendChild(card);
            });
            
            subGrid.style.display = 'grid';
        }
        
        // åˆ‡æ›ç”¢æ¥­é¸æ“‡
        function toggleIndustrySelection(card, codes) {
            card.classList.toggle('selected');
            
            const isSelected = card.classList.contains('selected');
            
            codes.forEach(code => {
                const businessItem = code.Business_Item || code.æ¥­åˆ¥ä»£ç¢¼;
                if (isSelected) {
                    if (!selectedIndustries.includes(businessItem)) {
                        selectedIndustries.push(businessItem);
                    }
                } else {
                    selectedIndustries = selectedIndustries.filter(item => item !== businessItem);
                }
            });
        }
        
        // ç”¢æ¥­æœå°‹
        function searchByIndustry() {
            if (selectedIndustries.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç”¢æ¥­åˆ†é¡');
                return;
            }
            
            showLoading();
            
            setTimeout(() => {
                searchResults = allCompanies.filter(company => {
                    return selectedIndustries.some(code => company.business.includes(code));
                });
                
                displayResults(searchResults, `é¸å®šç”¢æ¥­ï¼ˆ${selectedIndustries.length} å€‹åˆ†é¡ï¼‰`);
            }, 300);
        }
        
        // è³‡æœ¬é¡æœå°‹
        function searchByCapital() {
            const min = parseInt(document.getElementById('minCapital').value) || 0;
            const max = parseInt(document.getElementById('maxCapital').value) || Infinity;
            
            showLoading();
            
            setTimeout(() => {
                searchResults = allCompanies.filter(company => 
                    company.capital >= min && company.capital <= max
                );
                
                displayResults(searchResults, `è³‡æœ¬é¡ ${formatNumber(min)} - ${formatNumber(max)}`);
            }, 300);
        }
        
        // è¨­å®šè³‡æœ¬é¡ç¯„åœ
        function setCapitalRange(min, max) {
            document.getElementById('minCapital').value = min;
            document.getElementById('maxCapital').value = max;
            searchByCapital();
        }
        
        // æœå°‹æ–°è¨­ç«‹å…¬å¸
        function searchNewCompanies() {
            const months = parseInt(document.getElementById('newCompanyMonth').value);
            const cutoffDate = new Date();
            cutoffDate.setMonth(cutoffDate.getMonth() - months);
            
            showLoading();
            
            setTimeout(() => {
                searchResults = allCompanies.filter(company => {
                    if (!company.date) return false;
                    
                    // è½‰æ›æ—¥æœŸæ ¼å¼ (æ°‘åœ‹å¹´)
                    const dateStr = company.date.toString();
                    if (dateStr.length === 7) {
                        const year = parseInt(dateStr.substring(0, 3)) + 1911;
                        const month = parseInt(dateStr.substring(3, 5));
                        const day = parseInt(dateStr.substring(5, 7));
                        const companyDate = new Date(year, month - 1, day);
                        
                        return companyDate >= cutoffDate;
                    }
                    return false;
                });
                
                displayResults(searchResults, `æœ€è¿‘ ${months} å€‹æœˆæ–°è¨­ç«‹`);
            }, 300);
        }
        
        // é€²éšæœå°‹
        function advancedSearch() {
            const keyword = document.getElementById('advKeyword').value.trim().toLowerCase();
            const status = document.getElementById('advStatus').value;
            const address = document.getElementById('advAddress').value.trim().toLowerCase();
            const industry = document.getElementById('advIndustry').value;
            const minCapital = parseInt(document.getElementById('advMinCapital').value) || 0;
            const maxCapital = parseInt(document.getElementById('advMaxCapital').value) || Infinity;
            
            showLoading();
            
            setTimeout(() => {
                searchResults = allCompanies.filter(company => {
                    // é—œéµå­—ç¯©é¸
                    if (keyword && !company.name.toLowerCase().includes(keyword)) {
                        return false;
                    }
                    
                    // ç‹€æ…‹ç¯©é¸
                    if (status && company.status !== status) {
                        return false;
                    }
                    
                    // åœ°å€ç¯©é¸
                    if (address && !company.address.toLowerCase().includes(address)) {
                        return false;
                    }
                    
                    // ç”¢æ¥­ç¯©é¸
                    if (industry && !company.business.includes(industry)) {
                        return false;
                    }
                    
                    // è³‡æœ¬é¡ç¯©é¸
                    if (company.capital < minCapital || company.capital > maxCapital) {
                        return false;
                    }
                    
                    return true;
                });
                
                displayResults(searchResults, 'é€²éšæœå°‹');
            }, 300);
        }
        
        // é¡¯ç¤ºçµæœ
        function displayResults(results, searchType) {
            const container = document.getElementById('resultsContainer');
            const statsDisplay = document.getElementById('statsDisplay');
            const exportSection = document.getElementById('exportSection');
            
            document.getElementById('searchResultsCount').textContent = results.length.toLocaleString();
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ˜•</div>
                        <h3>æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„å…¬å¸</h3>
                        <p>è«‹èª¿æ•´æœå°‹æ¢ä»¶å¾Œé‡è©¦</p>
                    </div>
                `;
                statsDisplay.innerHTML = `æœå°‹çµæœï¼š<strong>0</strong> ç­†`;
                exportSection.style.display = 'none';
                return;
            }
            
            let html = '';
            const displayLimit = 100;
            const displayData = results.slice(0, displayLimit);
            
            displayData.forEach(company => {
                const tags = autoTagCompany(company);
                const tagsHtml = tags.map(tag => 
                    `<span class="customer-tag ${tag.class}">${tag.label}</span>`
                ).join('');
                
                html += `
                    <div class="customer-card">
                        <div class="customer-header">
                            <div style="flex: 1;">
                                <div class="customer-name">${company.name}</div>
                                <div class="customer-type">çµ±ç·¨ï¼š${company.taxId || 'æœªæä¾›'}</div>
                            </div>
                            <div class="customer-tags">
                                ${tagsHtml}
                            </div>
                        </div>
                        <div class="customer-info">
                            <div class="info-item"><span class="info-icon">ğŸ“</span> ${company.address || 'æœªæä¾›'}</div>
                            <div class="info-item"><span class="info-icon">ğŸ’°</span> è³‡æœ¬é¡ï¼š${formatCapital(company.capital)}</div>
                            <div class="info-item"><span class="info-icon">ğŸ“Š</span> ${company.status || 'æœªæä¾›'}</div>
                            <div class="info-item"><span class="info-icon">ğŸ‘¤</span> è² è²¬äººï¼š${company.chairman || 'æœªæä¾›'}</div>
                            <div class="info-item"><span class="info-icon">ğŸ“…</span> æˆç«‹ï¼š${formatDate(company.date)}</div>
                        </div>
                    </div>
                `;
            });
            
            if (results.length > displayLimit) {
                html += `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        é¡¯ç¤ºå‰ ${displayLimit} ç­†ï¼Œå…± ${results.length.toLocaleString()} ç­†çµæœ
                    </div>
                `;
            }
            
            container.innerHTML = html;
            statsDisplay.innerHTML = `${searchType} - æ‰¾åˆ° <strong>${results.length.toLocaleString()}</strong> ç­†çµæœ`;
            exportSection.style.display = 'flex';
        }
        
        // è‡ªå‹•æ¨™ç±¤
        function autoTagCompany(company) {
            const tags = [];
            
            // è³‡æœ¬é¡åˆ†ç´š
            if (company.capital >= 100000000) {
                tags.push({ label: 'è¶…å¤§å‹', class: 'tag-high' });
            } else if (company.capital >= 10000000) {
                tags.push({ label: 'å¤§å‹', class: 'tag-high' });
            } else if (company.capital >= 1000000) {
                tags.push({ label: 'ä¸­å‹', class: 'tag-medium' });
            } else {
                tags.push({ label: 'å°å‹', class: 'tag-low' });
            }
            
            // æ–°è¨­ç«‹å…¬å¸ï¼ˆ1å¹´å…§ï¼‰
            if (company.date) {
                const dateStr = company.date.toString();
                if (dateStr.length === 7) {
                    const year = parseInt(dateStr.substring(0, 3)) + 1911;
                    const companyYear = new Date().getFullYear() - year;
                    if (companyYear <= 1) {
                        tags.push({ label: 'æ–°è¨­ç«‹', class: 'tag-new' });
                    }
                }
            }
            
            return tags;
        }
        
        // æ ¼å¼åŒ–è³‡æœ¬é¡
        function formatCapital(amount) {
            if (!amount || amount === 0) return 'æœªæä¾›';
            if (amount >= 100000000) return (amount / 100000000).toFixed(1) + 'å„„';
            if (amount >= 10000) return (amount / 10000).toFixed(0) + 'è¬';
            return amount.toLocaleString();
        }
        
        // æ ¼å¼åŒ–æ•¸å­—
        function formatNumber(num) {
            if (num === Infinity) return 'ä¸é™';
            if (num >= 100000000) return (num / 100000000) + 'å„„';
            if (num >= 10000) return (num / 10000) + 'è¬';
            return num.toLocaleString();
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return 'æœªæä¾›';
            const str = dateStr.toString();
            if (str.length === 7) {
                const year = parseInt(str.substring(0, 3)) + 1911;
                const month = str.substring(3, 5);
                const day = str.substring(5, 7);
                return `${year}/${month}/${day}`;
            }
            return dateStr;
        }
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        function showLoading() {
            document.getElementById('resultsContainer').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨æœå°‹...</p>
                </div>
            `;
        }
        
        // åŒ¯å‡º CSV
        function exportToCSV() {
            if (searchResults.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
                return;
            }
            
            let csv = '\uFEFFå…¬å¸åç¨±,çµ±ä¸€ç·¨è™Ÿ,è² è²¬äºº,è³‡æœ¬é¡,åœ°å€,ç‹€æ…‹,æˆç«‹æ—¥æœŸ,æ‰€ç‡Ÿäº‹æ¥­\n';
            
            searchResults.forEach(company => {
                csv += `"${company.name}","${company.taxId}","${company.chairman}","${company.capital}","${company.address}","${company.status}","${formatDate(company.date)}","${company.business}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `æ½›åœ¨å®¢æˆ¶_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // åŒ¯å‡º Excel æ ¼å¼
        function exportToExcel() {
            exportToCSV(); // ç›®å‰ä½¿ç”¨ç›¸åŒé‚è¼¯
        }
    </script>
</body>
</html>
